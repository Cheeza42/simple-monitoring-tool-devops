pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command:
    - /busybox/sh
    - -c
    - sleep 3650d
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  - name: python
    image: python:3.11-slim
    command:
    - sh
    - -c
    - cat
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  volumes:
  - name: workspace-volume
    emptyDir: {}
"""
    }
  }

  environment {
    DOCKERHUB_USERNAME = credentials('cheeza42-username')
    DOCKERHUB_PASSWORD = credentials('cheeza42-password')

    IMAGE_NAME = 'docker.io/cheeza42/simple-monitoring-api'
    BUILD_CONTEXT = '.'
    DOCKERFILE_PATH = 'Dockerfile'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Compute Tag') {
      steps {
        script {
          def ts = sh(returnStdout: true, script: "date +%Y%m%d-%H%M%S").trim()
          def sha7 = (env.GIT_COMMIT ?: "nogit").take(7)
          env.IMAGE_TAG = "${ts}-${sha7}"
        }
      }
    }

    stage('Parallel Checks') {
      parallel {
        stage('Python syntax & deps') {
          steps {
            container('python') {
              sh """
              set -e
              python -V
              python -m pip install --upgrade pip
              test -f requirements.txt && python -m pip install -r requirements.txt
              python -m compileall src
              python -m pip check
              """
            }
          }
        }

        stage('Tests (if exist)') {
          steps {
            container('python') {
              sh """
              set -e
              if [ -d tests ]; then
                python -m pip install --upgrade pip
                test -f requirements.txt && python -m pip install -r requirements.txt
                python -m pip install pytest
                pytest -q
              else
                echo "No tests/ directory - skipping pytest"
              fi
              """
            }
          }
        }
      }
    }

    stage('Build & Push (Kaniko)') {
      steps {
        container('kaniko') {
          sh """
          set -e
          mkdir -p /kaniko/.docker
          AUTH=\$(printf "%s" "${DOCKERHUB_USERNAME}:${DOCKERHUB_PASSWORD}" | base64 | tr -d '\\n')
          printf '{"auths":{"https://index.docker.io/v1/":{"auth":"%s"}}}\\n' "\$AUTH" > /kaniko/.docker/config.json
          DF_REL="\${DOCKERFILE_PATH#\${BUILD_CONTEXT}/}"
          [ "\$DF_REL" = "\${DOCKERFILE_PATH}" ] && DF_REL="\${DOCKERFILE_PATH}"
          test -f "\${BUILD_CONTEXT}/\${DF_REL}" || { echo "Dockerfile not found at \${BUILD_CONTEXT}/\${DF_REL}"; exit 1; }
          /kaniko/executor \
            --verbosity=debug \
            --context="\${BUILD_CONTEXT}" \
            --dockerfile="\${DOCKERFILE_PATH}" \
            --destination="\${IMAGE_NAME}:\${IMAGE_TAG}" \
            --destination="\${IMAGE_NAME}:latest"
          """
        }
      }
    }
  }
}
